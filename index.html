<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EGR Careers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* simple styling — adapt to match your main site */
    body{font-family:system-ui,Segoe UI,Arial;margin:16px;background:#f7f8fb}
    .job{background:#fff;padding:16px;margin:12px 0;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
    .controls{display:flex;gap:8px;margin-bottom:12px}
    button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
  </style>
</head>
<body>
  <h1>Emirates Group Roblox — Careers</h1>
  <div class="controls">
    <input id="q" placeholder="Search roles..." />
    <select id="status">
      <option value="">All</option><option>Open</option><option>Closed</option>
    </select>
    <button id="search">Search</button>
  </div>

  <div id="jobs"></div>

  <!-- Apply modal -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center">
    <div style="background:#fff;padding:16px;border-radius:8px;max-width:640px;width:95%">
      <h3 id="modal-title">Apply</h3>
      <form id="applyForm">
        <input type="hidden" name="job_id" id="job_id" />
        <div><label>First name</label><input name="first_name" required /></div>
        <div><label>Last name</label><input name="last_name" /></div>
        <div><label>Email</label><input name="email" type="email" required/></div>
        <div><label>Discord</label><input name="discord_username" /></div>
        <div><label>Discord ID</label><input name="discord_id" /></div>
        <div><label>Roblox username</label><input name="roblox_username" /></div>
        <div><label>Age</label><input name="age" /></div>
        <div><label>Country</label><input name="country" /></div>
        <div><label>Region</label><input name="region" /></div>
        <div><label>Why do you want this role?</label><textarea name="cover_letter"></textarea></div>
        <div style="margin-top:8px"><button type="submit">Submit application</button> <button type="button" onclick="closeModal()">Cancel</button></div>
      </form>
    </div>
  </div>

<script>
const API = '<<PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL>>?'; // include trailing ?
async function fetchJobs(q='', status='') {
  const url = API + 'path=getJobs' + (q ? '&q=' + encodeURIComponent(q) : '') + (status ? '&status=' + encodeURIComponent(status) : '');
  const res = await fetch(url);
  const data = await res.json();
  return data.jobs || [];
}
function renderJob(job){
  return `
  <div class="job">
    <h3>${job.title} <small>(${job.location || 'Remote'})</small></h3>
    <p><strong>Status:</strong> ${job.status} • <strong>Division:</strong> ${job.division}</p>
    <p>${job.summary || ''}</p>
    <button onclick="openApply('${job.job_id}','${job.title.replace(/'/g,"\\'")}')">Apply</button>
  </div>`;
}

document.getElementById('search').addEventListener('click', async ()=>{
  const q = document.getElementById('q').value;
  const status = document.getElementById('status').value;
  const jobs = await fetchJobs(q,status);
  const container = document.getElementById('jobs');
  container.innerHTML = jobs.map(renderJob).join('');
});

async function init() {
  const jobs = await fetchJobs();
  document.getElementById('jobs').innerHTML = jobs.map(renderJob).join('');
}
init();

function openApply(job_id, title){
  document.getElementById('modal').style.display='flex';
  document.getElementById('modal-title').textContent = 'Apply for ' + title;
  document.getElementById('job_id').value = job_id;
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

document.getElementById('applyForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const form = new FormData(ev.target);
  const body = Object.fromEntries(form.entries());
  const res = await fetch(API, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(Object.assign({action:'apply'}, body))
  });
  const json = await res.json();
  if (json.ok) {
    alert('Application received! Application ID: ' + json.application_id);
    closeModal();
  } else {
    alert('Error: ' + (json.error || 'unknown'));
  }
});
</script>
</body>
</html>
