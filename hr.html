<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>EGR Careers — HR Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/css/careers.css?v=hr-gate"/>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script defer src="/js/supabaseClient.js?v=hr-gate"></script>
  <style>
    .center{min-height:70vh;display:grid;place-items:center}
    .card{max-width:720px;width:100%}
    .ok{border:1px solid #2a7240;background:#0e2a18;color:#c9f5d2;border-radius:12px;padding:14px}
    .no{border:1px solid #6b1a3a;background:#2b1324;color:#ffd7e6;border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button{padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:#fff}
    button.btn{cursor:pointer}
  </style>
</head>
<body class="container" style="padding-top:18px">
  <h1>HR Portal</h1>
  <p class="meta">You must be signed in and have the <strong>HR</strong> role to continue.</p>

  <div id="box" class="center">
    <div class="card">Checking access…</div>
  </div>

  <!-- Sign-in modal -->
  <dialog id="authModal" class="modal">
    <form method="dialog" class="card" onsubmit="return false;">
      <h3>Sign in required</h3>
      <input type="email" id="authEmail" placeholder="Email address" required />
      <input type="password" id="authPass" placeholder="Password" required />
      <div class="row">
        <button class="btn" id="loginBtn">Sign In</button>
        <button class="btn ghost" id="signupBtn">Create Account</button>
        <button class="btn red" onclick="document.getElementById('authModal').close()">Close</button>
      </div>
      <p id="authMsg" class="meta"></p>
    </form>
  </dialog>

  <script>
    async function checkAccess(){
      const box = document.getElementById('box');
      // 1) Are you signed in?
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        box.innerHTML = `
          <div class="card no">
            <p><strong>Not signed in.</strong> You must sign in to access the HR Portal.</p>
            <button class="btn" id="openLogin">Sign In</button>
          </div>`;
        document.getElementById('openLogin').onclick = () => document.getElementById('authModal').showModal();
        wireAuth();
        return;
      }

      // 2) Do you have the HR role?
      const user = session.user;
      const { data: roles, error } = await supabase.from('user_roles').select('role').eq('user_id', user.id);
      if (error) {
        box.innerHTML = `<div class="card no">Role check failed: ${error.message}</div>`;
        return;
      }
      const isHR = roles?.some(r => r.role === 'hr');
      if (!isHR) {
        box.innerHTML = `<div class="card no"><strong>Access denied.</strong> Your account does not have the HR role.</div>`;
        return;
      }

      // 3) Access granted
      box.innerHTML = `
        <div class="ok">
          <p><strong>Access granted.</strong> Signed in as ${user.email} (HR)</p>
          <div class="row" style="margin-top:10px">
            <a class="btn" href="/hr-dashboard.html">Go to HR Dashboard</a>
            <a class="btn ghost" href="/jobs.html">View public jobs</a>
          </div>
        </div>
      `;
    }

    function wireAuth(){
      const email = document.getElementById('authEmail');
      const pass  = document.getElementById('authPass');
      const msg   = document.getElementById('authMsg');

      document.getElementById('loginBtn')?.addEventListener('click', async ()=>{
        const { error } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: pass.value.trim() });
        msg.textContent = error ? error.message : 'Signed in — reloading…';
        if (!error) location.reload();
      });

      document.getElementById('signupBtn')?.addEventListener('click', async ()=>{
        const { error } = await supabase.auth.signUp({ email: email.value.trim(), password: pass.value.trim() });
        msg.textContent = error ? error.message : 'Account created — check email, then Sign In.';
      });
    }

    checkAccess();
  </script>
</body>
</html>
